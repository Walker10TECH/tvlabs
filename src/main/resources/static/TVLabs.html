<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlow | Sports & Live TV</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Flatpickr (Calendar) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#ef4444', 600: '#dc2626' }, // Mudança para Vermelho (Esportes/Ação)
                        dark: { 900: '#0a0a0a', 800: '#171717', 700: '#262626' }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Iframe Responsive Wrapper */
        .iframe-container { position: relative; width: 100%; height: 100%; }
        .iframe-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        
        /* Custom Styles for Sports UI */
        .dropdown-menu { opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s; }
        .dropdown-menu.open { opacity: 1; visibility: visible; transform: translateY(0); }
        .dropdown-item { padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #d1d5db; }
        .dropdown-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .dropdown-item img { width: 20px; height: 20px; object-fit: contain; }

        .match-card { background: #1a1b1e; border: 1px solid #333; border-radius: 12px; overflow: hidden; transition: transform 0.2s, border-color 0.2s; cursor: pointer; position: relative; }
        .match-card:hover { transform: translateY(-2px); border-color: #555; }
        
        .tv-scoreboard { display: grid; grid-template-columns: 50px 1fr auto 1fr 50px; align-items: center; padding: 16px; gap: 8px; position: relative; z-index: 1; }
        .tv-scoreboard-bg { position: absolute; inset: 0; opacity: 0.1; z-index: -1; background-size: cover; background-position: center; }
        .tv-logo-box img { width: 32px; height: 32px; object-fit: contain; margin: auto; }
        .tv-team-box { font-weight: 700; font-size: 14px; color: white; display: flex; align-items: center; gap: 8px; }
        .tv-score-box { font-family: 'Inter', sans-serif; font-weight: 900; font-size: 24px; color: white; background: rgba(0,0,0,0.5); padding: 4px 12px; border-radius: 6px; min-width: 80px; text-align: center; }
        .tv-time-box { font-size: 10px; color: #aaa; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .match-footer { background: rgba(0,0,0,0.3); padding: 8px 16px; font-size: 10px; color: #888; display: flex; justify-content: space-between; border-top: 1px solid #333; }
        
        .live-timer { color: #ef4444; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        .goal-animation { animation: goalFlash 0.8s ease-out; }
        @keyframes goalFlash { 0% { transform: scale(1); color: white; } 50% { transform: scale(1.5); color: #d1ff4d; } 100% { transform: scale(1); color: white; } }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 50; opacity: 0; visibility: hidden; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: #171717; width: 95%; max-width: 800px; max-height: 90vh; border-radius: 16px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; transform: scale(0.95); transition: all 0.3s; }
        .modal-overlay.open .modal-content { transform: scale(1); }

        /* Themes */
        /* --- TEMA BRASILEIRÃO (Globo/Premiere) --- */
        .theme-brasileirao .tv-scoreboard { background: linear-gradient(to bottom, #ffffff, #f0f0f0); color: #000000; border-bottom: 2px solid #e5e5e5; }
        .theme-brasileirao .tv-logo-box { background: #f0f0f0; border-right: 1px solid #e5e5e5; } 
        .theme-brasileirao .tv-score-box { background-color: #000000; color: #ffffff; min-width: 56px; }
        .theme-brasileirao .tv-time-box { background: linear-gradient(to bottom, #d1ff4d, #b8e62e); color: #000000; }

        /* --- TEMA BRASILEIRÃO 2025 (Globo Estilo Novo) --- */
        .theme-brasileirao-2025 .tv-scoreboard { background-color: transparent; color: #ffffff; }
        .theme-brasileirao-2025 .tv-logo-box { display: none; } /* Logo da liga não aparece no placar principal */
        .theme-brasileirao-2025 .tv-team-box { background-color: var(--bg-card); flex-basis: 40%; }
        .theme-brasileirao-2025 .tv-team-box.home { background-color: var(--home-color, #333); border-radius: 8px 0 0 8px; }
        .theme-brasileirao-2025 .tv-team-box.away { background-color: var(--away-color, #333); border-radius: 0 8px 8px 0; }
        .theme-brasileirao-2025 .tv-central-box {
            background-color: #111;
            color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%;
            padding: 0 10px;
            min-width: 60px;
        }
        .theme-brasileirao-2025 .tv-central-time { font-size: 0.7rem; font-weight: 700; opacity: 0.8; }
        .theme-brasileirao-2025 .tv-central-score { font-size: 1.2rem; font-weight: 800; letter-spacing: 2px; }

        /* --- TEMA BRASILEIRÃO SÉRIE B --- */
        .theme-brasileiraob .tv-scoreboard { background: linear-gradient(90deg, #003366, #004080); color: white; border-bottom: 3px solid #00ff85; }
        .theme-brasileiraob .tv-logo-box { background: #fff; }
        .theme-brasileiraob .tv-score-box { background-color: rgba(255,255,255,0.1); }
        .theme-brasileiraob .tv-time-box { background-color: #00ff85; color: #003366; }

        /* --- TEMA LIBERTADORES (Conmebol Dark) --- */
        .theme-libertadores .tv-scoreboard { background: linear-gradient(to bottom, #1a1a1a, #000000); color: #ffffff; border-bottom: 3px solid #d4af37; }
        .theme-libertadores .tv-logo-box { background: #111; }
        .theme-libertadores .tv-score-box { background-color: #1a1a1a; color: #ffffff; border-left: 1px solid #333; border-right: 1px solid #333; }
        .theme-libertadores .tv-time-box { background-color: #d4af37; color: #000000; }

        /* --- TEMA SULAMERICANA --- */
        .theme-sulamericana .tv-scoreboard { background: linear-gradient(90deg, #0a1e40 0%, #000000 100%); color: #ffffff; border-bottom: 3px solid #a0a0a0; }
        .theme-sulamericana .tv-score-box { background-color: rgba(255,255,255,0.1); }
        .theme-sulamericana .tv-time-box { background-color: #a0a0a0; color: #000000; }

        /* --- TEMA CHAMPIONS LEAGUE --- */
        .theme-champions .tv-scoreboard { background: linear-gradient(135deg, #001c55 0%, #043496 100%); color: #ffffff; border-radius: 0 0 12px 12px; }
        .theme-champions .tv-scoreboard::before { content: '★'; position: absolute; right: 60px; top: -10px; font-size: 4rem; color: rgba(255,255,255,0.05); pointer-events: none; }
        .theme-champions .tv-score-box { border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1); }
        .theme-champions .tv-time-box { background: rgba(255,255,255,0.2); color: #fff; }

        /* --- TEMA PREMIER LEAGUE --- */
        .theme-premier .tv-scoreboard { background: linear-gradient(135deg, #38003c, #5a005f); color: #ffffff; }
        .theme-premier .tv-logo-box { background: #00ff85; }
        .theme-premier .tv-score-box { background-color: #fff; color: #38003c; }
        .theme-premier .tv-time-box { background-color: #00ff85; color: #38003c; }

        /* --- TEMA LA LIGA --- */
        .theme-laliga .tv-scoreboard { background: linear-gradient(135deg, #1a1a1a, #000); color: #fff; border-bottom: 2px solid #ff0040; }
        .theme-laliga .tv-score-box { font-weight: 900; font-size: 2rem; }
        .theme-laliga .tv-time-box { background-color: #ff0040; color: white; }

        /* --- TEMA BUNDESLIGA --- */
        .theme-bundesliga .tv-scoreboard { background: linear-gradient(135deg, #d20515, #e03e4b); color: #ffffff; }
        .theme-bundesliga .tv-score-box { background-color: #ffffff; color: #000000; }
        .theme-bundesliga .tv-time-box { background-color: #a0000c; color: #ffffff; }

        /* --- TEMA SERIE A (ITÁLIA) --- */
        .theme-seriea .tv-scoreboard { background: linear-gradient(135deg, #00458c, #006ab5); color: #ffffff; }
        .theme-seriea .tv-time-box { background-color: rgba(0,0,0,0.3); }

        /* --- TEMA SAUDITA (Roshn League) --- */
        .theme-saudi .tv-scoreboard { background: linear-gradient(to bottom, #ffffff, #f5f5f5); color: #003d20; border-bottom: 2px solid #e5e5e5; }
        .theme-saudi .tv-logo-box { background: #f0f0f0; border-right: 1px solid #e5e5e5; }
        .theme-saudi .tv-score-box { background-color: #003d20; color: #ffffff; }
        .theme-saudi .tv-time-box { background: linear-gradient(to bottom, #00b140, #009a36); color: #ffffff; }

        /* --- TEMA ARGENTINA --- */
        .theme-argentina .tv-scoreboard { background: linear-gradient(90deg, #75aadb 0%, #ffffff 100%); color: #0d2c4c; border-bottom: 2px solid #75aadb; }
        .theme-argentina .tv-logo-box { background: #fff; }
        .theme-argentina .tv-score-box { background-color: #0d2c4c; color: #ffffff; }
        .theme-argentina .tv-time-box { background: linear-gradient(to bottom, #0d2c4c, #0a223a); color: #ffffff; }

        /* --- TEMA EREDIVISIE (HOLANDÊS) --- */
        .theme-eredivisie .tv-scoreboard { background: linear-gradient(to bottom, #e30613, #c40411); color: #ffffff; }
        .theme-eredivisie .tv-logo-box { background: #fff; }
        .theme-eredivisie .tv-score-box { background-color: #ffffff; color: #000000; }
        .theme-eredivisie .tv-time-box { background-color: #000000; color: #ffffff; }

        /* --- TEMA OLIMPÍADAS --- */
        .theme-olympics .tv-scoreboard { background: linear-gradient(135deg, #0077c8, #005a9a); color: white; border-bottom: 3px solid #f4c300; }
        .theme-olympics .tv-logo-box { background: #fff; }
        .theme-olympics .tv-score-box { background-color: rgba(0,0,0,0.2); font-size: 1.5rem; }
        .theme-olympics .tv-time-box { background-color: #f4c300; color: #005a9a; }
        .theme-olympics .tv-team-box img { border: 1px solid #eee; }

        /* Medal Table */
        .medal-table .gold { color: #ffd700; }
        .medal-table .silver { color: #c0c0c0; }
        .medal-table .bronze { color: #cd7f32; }
        .medal-table .country-cell { display: flex; align-items: center; gap: 8px; }
        .medal-table .country-cell img { width: 24px; border: 1px solid #444; }

        /* --- TEMA COPA AMÉRICA --- */
        .theme-copaamerica .tv-scoreboard { background: linear-gradient(90deg, #00387b, #005c31); color: white; border-bottom: 3px solid #fdd116; }
        .theme-copaamerica .tv-logo-box { background: #fff; }
        .theme-copaamerica .tv-score-box { background-color: rgba(0,0,0,0.2); }
        .theme-copaamerica .tv-time-box { background-color: #fdd116; color: #00387b; }

        /* Match Info Footer */
        .match-footer {
            padding: 8px 12px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.75rem; color: #888;
            background: #1a1b1e;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        /* ==========================================================================
        STANDINGS TABLE THEMES
        ========================================================================== */
        .standings-group-header { background-color: rgba(255,255,255,0.05); }
        .theme-brasileirao .standings-group-header { background: linear-gradient(to bottom, #ffffff, #f0f0f0); }
        .theme-brasileirao .standings-group-header span { color: #000; }
        .theme-brasileiraob .standings-group-header { background: linear-gradient(90deg, #003366, #004080); border-bottom: 3px solid #00ff85; }
        .theme-libertadores .standings-group-header { background: linear-gradient(to bottom, #1a1a1a, #000000); border-bottom: 3px solid #d4af37; }
        .theme-sulamericana .standings-group-header { background: linear-gradient(90deg, #0a1e40 0%, #000000 100%); border-bottom: 3px solid #a0a0a0; }
        .theme-champions .standings-group-header { background: linear-gradient(135deg, #001c55 0%, #043496 100%); }
        .theme-premier .standings-group-header { background: linear-gradient(135deg, #38003c, #5a005f); }
        .theme-laliga .standings-group-header { background: linear-gradient(135deg, #1a1a1a, #000); border-bottom: 2px solid #ff0040; }
        .theme-bundesliga .standings-group-header { background: linear-gradient(135deg, #d20515, #e03e4b); }
        .theme-seriea .standings-group-header { background: linear-gradient(135deg, #00458c, #006ab5); }
        .theme-saudi .standings-group-header { background: linear-gradient(to bottom, #ffffff, #f5f5f5); border-bottom: 2px solid #e5e5e5; }
        .theme-saudi .standings-group-header span { color: #003d20; }
        .theme-argentina .standings-group-header { background: linear-gradient(90deg, #75aadb 0%, #ffffff 100%); border-bottom: 2px solid #75aadb; }
        .theme-argentina .standings-group-header span { color: #0d2c4c; }
        .theme-eredivisie .stand-group-header { background: linear-gradient(to bottom, #e30613, #c40411); }
        .theme-olympics .standings-group-header { background: linear-gradient(135deg, #0077c8, #005a9a); border-bottom: 3px solid #f4c300; }
        .theme-copaamerica .standings-group-header { background: linear-gradient(90deg, #00387b, #005c31); border-bottom: 3px solid #fdd116; }

        /* Timeline */
        .timeline-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid #333; align-items: flex-start; }
        .timeline-time { font-weight: bold; color: #888; width: 40px; text-align: right; font-size: 12px; padding-top: 2px; }

        /* Loader */
        .loader-hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s; }
    </style>
</head>
<body class="bg-dark-900 text-white font-sans h-screen overflow-hidden flex relative">

    <!-- Global Loader -->
    <div id="global-loader" class="fixed inset-0 bg-dark-900 z-[100] flex flex-col items-center justify-center">
        <div class="animate-spin w-12 h-12 border-4 border-brand-500 border-t-transparent rounded-full mb-4"></div>
        <div class="text-gray-400 text-sm font-medium animate-pulse">Carregando StreamFlow...</div>
    </div>

    <!-- Background Wrapper (Themed) -->
    <div id="bg-wrapper" class="fixed inset-0 bg-cover bg-center opacity-10 pointer-events-none transition-all duration-1000 z-0" style="background-image: url('https://admin.cnnbrasil.com.br/wp-content/uploads/sites/12/2024/04/taca-e1712177532245.jpeg?w=910');"></div>

    <!-- Sidebar -->
    <aside class="w-20 lg:w-64 bg-dark-800/90 backdrop-blur border-r border-dark-700 flex flex-col justify-between hidden md:flex z-20 relative">
        <div>
            <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-dark-700">
                <i data-lucide="zap" class="w-6 h-6 text-brand-500 mr-0 lg:mr-3"></i>
                <span class="font-bold text-xl hidden lg:block tracking-tight">StreamFlow</span>
            </div>

            <div class="p-4">
                <!-- Sport Selector -->
                <div class="relative dropdown-container mb-4">
                    <button onclick="app.toggleDropdown('sport-menu')" class="w-full bg-dark-700 hover:bg-dark-600 text-white p-3 rounded-lg flex items-center justify-between transition">
                        <span id="header-sport-name" class="font-bold">Futebol</span>
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </button>
                    <div id="sport-menu" class="dropdown-menu absolute top-full left-0 w-full bg-dark-800 border border-dark-600 rounded-lg mt-2 shadow-xl z-50 max-h-60 overflow-y-auto">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex flex-col gap-1">
                    <button id="desk-channels" onclick="app.setView('channels')" class="w-full text-left p-3 rounded-lg hover:bg-white/5 flex items-center gap-3 font-semibold text-gray-400 hover:text-white group">
                        <i data-lucide="tv" class="w-5 h-5 group-hover:text-brand-500 transition"></i> Canais TV
                    </button>
                    <button id="desk-matches" onclick="app.setView('matches')" class="w-full text-left p-3 rounded-lg bg-white/10 flex items-center gap-3 font-semibold text-white group">
                        <i data-lucide="calendar" class="w-5 h-5 text-[#d1ff4d]"></i> Jogos
                    </button>
                    <button id="desk-standings" onclick="app.setView('standings')" class="w-full text-left p-3 rounded-lg hover:bg-white/5 flex items-center gap-3 font-semibold text-gray-400 hover:text-white group">
                        <i data-lucide="list-ordered" class="w-5 h-5 group-hover:text-brand-500 transition"></i> Classificação
                    </button>
                    <button id="desk-scorers" onclick="app.setView('scorers')" class="w-full text-left p-3 rounded-lg hover:bg-white/5 flex items-center gap-3 font-semibold text-gray-400 hover:text-white group">
                        <i data-lucide="target" class="w-5 h-5 group-hover:text-brand-500 transition"></i> Artilharia
                    </button>
                    <button id="desk-news" onclick="app.setView('news')" class="w-full text-left p-3 rounded-lg hover:bg-white/5 flex items-center gap-3 font-semibold text-gray-400 hover:text-white group">
                        <i data-lucide="newspaper" class="w-5 h-5 group-hover:text-brand-500 transition"></i> Notícias
                    </button>
                    <button id="desk-clubs" onclick="app.setView('clubs')" class="w-full text-left p-3 rounded-lg hover:bg-white/5 flex items-center gap-3 font-semibold text-gray-400 hover:text-white group">
                        <i data-lucide="shield" class="w-5 h-5 group-hover:text-brand-500 transition"></i> Clubes
                    </button>
                </nav>

                <div class="my-4 border-t border-dark-700"></div>

                <!-- League List (Sidebar) -->
                <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 px-2">Ligas</div>
                <div id="sidebar-league-list" class="flex flex-col gap-1 max-h-[30vh] overflow-y-auto no-scrollbar">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-dark-700">
            <div class="bg-dark-700/50 rounded-lg p-3 flex items-center gap-3">
                <img id="region-flag" src="" class="w-6 h-4 object-cover rounded">
                <div>
                    <p class="text-xs text-gray-400">Região</p>
                    <p id="region-name" class="text-xs font-bold text-white">BR</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-dark-900/90 z-10">
        
        <!-- Top Bar -->
        <header class="h-16 border-b border-dark-700 flex items-center justify-between px-6 bg-dark-800/80 backdrop-blur z-20">
            <div class="md:hidden text-brand-500 font-bold text-lg flex items-center gap-2" onclick="app.toggleMobileMenu()">
                <i data-lucide="menu" class="w-6 h-6 text-white"></i>
                StreamFlow
            </div>
            
            <!-- League Selector (Desktop) -->
            <div class="hidden md:flex items-center gap-3 dropdown-container relative">
                <button onclick="app.toggleDropdown('league-menu')" class="flex items-center gap-2 hover:bg-white/5 px-3 py-1.5 rounded-full transition">
                    <img id="header-league-logo" src="" class="w-6 h-6 object-contain">
                    <span id="header-league-name" class="font-bold text-lg">Brasileirão</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                </button>
                <div id="league-menu" class="dropdown-menu absolute top-full left-0 w-64 bg-dark-800 border border-dark-600 rounded-lg mt-2 shadow-xl z-50 max-h-96 overflow-y-auto">
                    <!-- Injected by JS -->
                </div>
            </div>

            <!-- Search -->
            <div class="flex-1 max-w-md mx-auto px-4 hidden md:block relative" id="search-container">
                <div class="relative group">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-500 group-focus-within:text-brand-500"></i>
                    <input type="text" id="global-search-input" placeholder="Buscar times, jogadores..." 
                        class="w-full bg-dark-900 border border-dark-700 rounded-full py-2 pl-10 pr-4 text-sm text-gray-300 focus:outline-none focus:border-brand-500 transition">
                </div>
                <div id="global-search-results" class="absolute top-full left-0 w-full bg-dark-800 border border-dark-700 rounded-lg mt-2 shadow-xl hidden overflow-hidden z-50"></div>
            </div>

            <div class="flex items-center gap-4">
                <button class="md:hidden" onclick="app.toggleMobileSearch()">
                    <i data-lucide="search" class="w-5 h-5 text-white"></i>
                </button>
                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-brand-500 to-orange-500 p-0.5">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=King" class="rounded-full bg-dark-900">
                </div>
            </div>
        </header>

        <!-- Scroll Area -->
        <div class="flex-1 overflow-y-auto relative" id="main-scroll">
            
            <!-- Content Container -->
            <div class="p-4 md:p-8 max-w-7xl mx-auto pb-24">
                
                <!-- Channels View -->
                <div id="view-channels" class="hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="tv" class="w-6 h-6 text-brand-500"></i> Canais de TV
                        </h2>
                        <div class="flex gap-2">
                            <input type="text" id="channel-filter" placeholder="Filtrar canais..." class="bg-dark-800 border border-dark-600 rounded-lg px-3 py-1.5 text-sm text-white focus:outline-none focus:border-brand-500">
                            <button onclick="app.toggleFavoritesFilter()" id="btn-fav-filter" class="px-3 py-1.5 rounded-lg bg-dark-800 border border-dark-600 text-gray-400 hover:text-brand-500 hover:border-brand-500 transition flex items-center gap-2 text-sm font-bold">
                                <i data-lucide="heart" class="w-4 h-4"></i> <span class="hidden sm:inline">Favoritos</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Player for Channels -->
                    <div id="channel-player-container" class="w-full aspect-video bg-black rounded-xl overflow-hidden mb-8 hidden border border-dark-700 shadow-2xl relative group">
                        <div id="embed-player" class="iframe-container w-full h-full">
                            <iframe id="iframe-src" src="" allowfullscreen allow="encrypted-media" frameborder="0"></iframe>
                        </div>
                        <button onclick="document.getElementById('channel-player-container').classList.add('hidden'); document.getElementById('iframe-src').src='';" class="absolute top-4 right-4 bg-black/50 hover:bg-red-600 text-white p-2 rounded-full transition z-20">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div id="channels-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <!-- Matches View -->
                <div id="view-matches">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                        <div class="flex items-center gap-3">
                            <img id="page-league-logo" src="" class="w-10 h-10 object-contain bg-white/10 rounded p-1">
                            <div>
                                <h2 id="page-league-name" class="text-2xl font-bold text-white leading-none">Brasileirão</h2>
                                <p id="matches-date-title" class="text-sm text-gray-400 mt-1">Jogos de Hoje</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <div id="live-indicator" class="hidden px-3 py-1 bg-red-600/20 text-red-500 border border-red-600/50 rounded-full text-xs font-bold flex items-center gap-2 animate-pulse">
                                <span class="w-2 h-2 bg-red-500 rounded-full"></span> AO VIVO
                            </div>
                            <div class="relative">
                                <input type="text" id="date-picker" class="bg-dark-800 border border-dark-600 text-white text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full pl-10 p-2.5" placeholder="Selecionar data">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <i data-lucide="calendar" class="w-4 h-4 text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="matches-grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <!-- Standings View -->
                <div id="view-standings" class="hidden">
                    <div class="section-title mb-4 text-xl font-bold">Tabela de Classificação</div>
                    <div id="standings-container" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
                </div>

                <!-- Scorers View -->
                <div id="view-scorers" class="hidden">
                    <div class="section-title mb-4 text-xl font-bold">Artilharia</div>
                    <div id="scorers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- News View -->
                <div id="view-news" class="hidden">
                    <div class="section-title mb-4 text-xl font-bold">Últimas Notícias</div>
                    <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <!-- Clubs View -->
                <div id="view-clubs" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="section-title text-xl font-bold">Clubes</div>
                        <input type="text" id="club-search-input" placeholder="Filtrar clubes..." class="bg-dark-800 border border-dark-600 rounded-lg px-3 py-1 text-sm text-white focus:outline-none focus:border-brand-500">
                    </div>
                    <div id="clubs-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                </div>

                <!-- Wiki View -->
                <div id="view-wiki" class="hidden">
                    <button onclick="app.setView('matches')" class="mb-4 text-sm text-gray-400 hover:text-white flex items-center gap-1">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar
                    </button>
                    <div id="wiki-content" class="bg-dark-800 rounded-xl p-6 border border-dark-700"></div>
                </div>

            </div>
        </div>

        <!-- Back to Top -->
        <button id="back-to-top-btn" class="fixed bottom-20 right-6 bg-brand-600 text-white p-3 rounded-full shadow-lg opacity-0 invisible transition-all z-40 hover:bg-brand-500">
            <i data-lucide="arrow-up" class="w-5 h-5"></i>
        </button>
    </main>

    <!-- Mobile Navigation (Bottom) -->
    <div class="md:hidden fixed bottom-0 left-0 w-full bg-dark-800 border-t border-dark-700 flex justify-around py-3 z-50 pb-safe">
        <button id="mob-channels" onclick="app.setView('channels')" class="flex flex-col items-center gap-1 text-xs text-gray-500">
            <i data-lucide="tv" class="w-5 h-5"></i> Canais
        </button>
        <button id="mob-matches" onclick="app.setView('matches')" class="flex flex-col items-center gap-1 text-xs text-[#d1ff4d]">
            <i data-lucide="calendar" class="w-5 h-5"></i> Jogos
        </button>
        <button id="mob-standings" onclick="app.setView('standings')" class="flex flex-col items-center gap-1 text-xs text-gray-500">
            <i data-lucide="list-ordered" class="w-5 h-5"></i> Tabela
        </button>
        <button id="mob-news" onclick="app.setView('news')" class="flex flex-col items-center gap-1 text-xs text-gray-500">
            <i data-lucide="newspaper" class="w-5 h-5"></i> Notícias
        </button>
        <button id="mob-clubs" onclick="app.setView('clubs')" class="flex flex-col items-center gap-1 text-xs text-gray-500">
            <i data-lucide="shield" class="w-5 h-5"></i> Clubes
        </button>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/80 z-[60] hidden" onclick="app.toggleMobileMenu()"></div>
    
    <!-- Mobile Sidebar -->
    <div id="mobile-sidebar" class="fixed top-0 left-0 h-full w-64 bg-dark-800 z-[70] transform -translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-4 border-b border-dark-700 flex items-center justify-between">
            <span class="font-bold text-xl">Menu</span>
            <button onclick="app.toggleMobileMenu()"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div class="p-4 overflow-y-auto flex-1">
            <div class="font-bold text-gray-500 text-xs uppercase mb-2">Esportes</div>
            <div id="mob-sport-menu" class="flex flex-col gap-2 mb-6"></div>
            
            <div class="font-bold text-gray-500 text-xs uppercase mb-2">Ligas</div>
            <div id="mob-sidebar-league-list" class="flex flex-col gap-1"></div>
        </div>
    </div>

    <!-- Mobile Search Overlay -->
    <div id="mobile-search-overlay" class="fixed inset-0 bg-dark-900 z-[80] hidden flex flex-col p-4">
        <div class="flex items-center gap-4 mb-4">
            <div class="relative flex-1">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-500"></i>
                <input type="text" id="mobile-search-input" placeholder="Buscar..." class="w-full bg-dark-800 border border-dark-700 rounded-full py-2 pl-10 pr-4 text-white">
            </div>
            <button onclick="app.toggleMobileSearch()" class="text-white">Cancelar</button>
        </div>
        <div id="mobile-search-results" class="flex-1 overflow-y-auto"></div>
    </div>

    <!-- Match Modal -->
    <div id="match-modal" class="modal-overlay">
        <div class="modal-content h-[80vh]">
            <!-- Header -->
            <div class="relative p-6 bg-gradient-to-b from-black/50 to-transparent">
                <button onclick="app.closeModal('match-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="text-center text-xs text-gray-400 mb-2 uppercase tracking-wider" id="modal-status">AO VIVO</div>
                <div class="flex items-center justify-between px-4 md:px-12">
                    <div class="flex flex-col items-center w-1/3">
                        <img id="modal-home-logo" src="" class="w-16 h-16 md:w-20 md:h-20 object-contain mb-2">
                        <span id="modal-home" class="font-bold text-lg md:text-2xl text-center leading-none">HOME</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="text-4xl md:text-6xl font-black text-white flex items-center gap-2">
                            <span id="modal-score-home">0</span>
                            <span class="text-gray-600 text-2xl">:</span>
                            <span id="modal-score-away">0</span>
                        </div>
                        <div id="modal-pk-score" class="text-xs text-gray-400 mt-1 hidden"></div>
                        <div id="modal-agg-score" class="text-xs text-gray-400 mt-1 hidden"></div>
                    </div>
                    <div class="flex flex-col items-center w-1/3">
                        <img id="modal-away-logo" src="" class="w-16 h-16 md:w-20 md:h-20 object-contain mb-2">
                        <span id="modal-away" class="font-bold text-lg md:text-2xl text-center leading-none">AWAY</span>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-dark-700 px-6">
                <button id="tab-btn-timeline" onclick="app.setMatchTab('timeline')" class="px-4 py-3 text-sm font-bold border-b-2 border-brand-500 text-white">Lances</button>
                <button id="tab-btn-stats" onclick="app.setMatchTab('stats')" class="px-4 py-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white">Estatísticas</button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 bg-dark-800">
                <div id="match-tab-timeline">
                    <div id="game-info" class="text-xs text-gray-500 mb-4 flex gap-4 justify-center"></div>
                    <div id="timeline-container" class="flex flex-col gap-0"></div>
                </div>
                <div id="match-tab-stats" class="hidden">
                    <div id="stats-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Club Modal -->
    <div id="club-modal" class="modal-overlay">
        <div class="modal-content h-[80vh]">
            <div class="p-6 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <h2 id="club-modal-name" class="text-2xl font-bold text-white">Nome do Clube</h2>
                <button onclick="app.closeModal('club-modal')" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="flex border-b border-dark-700 px-6 bg-dark-800">
                <button id="club-tab-btn-history" onclick="app.setClubTab('history')" class="px-4 py-3 text-sm font-bold border-b-2 border-brand-500 text-white">História</button>
                <button id="club-tab-btn-squad" onclick="app.setClubTab('squad')" class="px-4 py-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white">Elenco</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-dark-900">
                <div id="club-view-history"></div>
                <div id="club-view-squad" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- JS Application Logic -->
    <script>
        const API_CONFIG = {
            ESPN_BASE_SITE: 'https://site.api.espn.com/apis/site/v2/sports',
            ESPN_BASE_V2: 'https://site.api.espn.com/apis/v2/sports',
            ESPN_BASE_CORE: 'https://sports.core.api.espn.com/v2/sports',
            ESPN_BASE_WEB: 'https://site.web.api.espn.com/apis',

            _buildUrl(targetUrl) {
                // Usa o proxy local do backend para evitar problemas de CORS e instabilidade
                return `/proxy?url=${encodeURIComponent(targetUrl)}`;
            },

            getScoreboardUrl(sport, leagueSlug, date) {
                const espnUrl = `${this.ESPN_BASE_SITE}/${sport}/${leagueSlug}/scoreboard?lang=pt&region=br&dates=${date}`;
                return this._buildUrl(espnUrl);
            },

            getNewsUrl(sport, leagueSlug, region = 'br') {
                const espnUrl = `${this.ESPN_BASE_SITE}/${sport}/${leagueSlug}/news?lang=pt&region=${region}`;
                return this._buildUrl(espnUrl);
            },

            getStandingsUrl(sport, leagueSlug) {
                const espnUrl = `${this.ESPN_BASE_WEB}/v2/sports/${sport}/${leagueSlug}/standings?lang=pt`;
                return this._buildUrl(espnUrl);
            },

            getGameSummaryUrl(sport, leagueSlug, eventId) {
                const espnUrl = `${this.ESPN_BASE_SITE}/${sport}/${leagueSlug}/summary?event=${eventId}&lang=pt`;
                return this._buildUrl(espnUrl);
            },

            getGameSummaryWithLeadersUrl(sport, leagueSlug, eventId) {
                const espnUrl = `${this.ESPN_BASE_SITE}/${sport}/${leagueSlug}/summary?event=${eventId}&lang=pt&contentorigin=espn`;
                return this._buildUrl(espnUrl);
            },

            getTeamRosterUrl(sport, leagueSlug, teamId) {
                const espnUrl = `${this.ESPN_BASE_SITE}/${sport}/${leagueSlug}/teams/${teamId}/roster`;
                return this._buildUrl(espnUrl);
            },

            getWikiSearchUrl(query) {
                return `https://pt.wikipedia.org/w/api.php?origin=*&action=opensearch&search=${encodeURIComponent(query)}&limit=5&format=json`;
            },

            getWikiParseUrl(term) {
                return `https://pt.wikipedia.org/w/api.php?origin=*&action=parse&page=${encodeURIComponent(term)}&prop=text&formatversion=2&format=json`;
            },

            getLeagueLeadersUrl(sport, leagueSlug) {
                const year = new Date().getFullYear();
                const espnUrl = `${this.ESPN_BASE_SITE}/${sport}/${leagueSlug}/scoreboard?dates=${year}`;
                return this._buildUrl(espnUrl);
            }
        };

        const app = {
            state: {
                currentSport: 'soccer',
                currentLeague: 'brasileirao',
                view: 'matches',
                region: 'br',
                timers: {},
                matchRefreshInterval: null,
                scoreboardRefreshInterval: null,
                currentDate: new Date(),
                playerCache: {},
                teamWikiDb: {},
                sports: {},
                previousStandings: {},
                isFirstStandingsRender: true,
                liveStandingsData: null,
                favorites: (() => {
                    try {
                        return JSON.parse(localStorage.getItem('tvlabs_favorites') || '[]');
                    } catch (e) { return []; }
                })(),
                showFavoritesOnly: false
            },

            async init() {
                try {
                    await Promise.all([
                        this.detectRegion(),
                        this.loadTeamWikiDb(),
                        this.loadSportsDb()
                    ]);
                    this._loadAdSenseScript();
                    this.renderNav();
                    this.loadLeague(this.state.currentLeague);
                } catch(e) { console.log(e); }
                finally { 
                    document.getElementById('global-loader').classList.add('loader-hidden'); 
                    lucide.createIcons();
                    this.setupEvents();
                }
            },

            _loadAdSenseScript() {
                // Optional: Keep or remove based on preference
            },

            async loadTeamWikiDb() {
                try {
                    const res = await fetch('/api/config/wiki');
                    this.state.teamWikiDb = await res.json();
                } catch(e) { console.error("Falha ao carregar Wiki DB", e); }
            },

            async loadSportsDb() {
                try {
                    const res = await fetch('/api/config/sports');
                    this.state.sports = await res.json();
                } catch(e) { console.error("Falha ao carregar Sports DB", e); }
            },

            async detectRegion() {
                try {
                    const r = await fetch('https://ipapi.co/json/');
                    const d = await r.json();
                    this.state.region = d.country_code ? d.country_code.toLowerCase() : 'br';
                } catch(e) {}
                document.getElementById('region-flag').src = `https://flagcdn.com/${this.state.region}.svg`;
                document.getElementById('region-name').innerText = this.state.region.toUpperCase();
            },

            setupEvents() {
                document.getElementById('global-search-input').addEventListener('keyup', this.debounce(e => this.handleSearch(e.target.value), 500));
                document.getElementById('mobile-search-input').addEventListener('keyup', this.debounce(e => this.handleSearch(e.target.value, true), 500));
                document.getElementById('club-search-input').addEventListener('keyup', this.debounce(e => this.filterClubs(e.target.value), 300));
                document.getElementById('channel-filter').addEventListener('keyup', this.debounce(e => this.filterChannels(e.target.value), 300));
                
                window.onclick = e => {
                    if(!e.target.closest('.dropdown-container')) document.querySelectorAll('.dropdown-menu').forEach(el=>el.classList.remove('open'));
                    if(!e.target.closest('#search-container')) document.getElementById('global-search-results').classList.add('hidden');
                };

                flatpickr("#date-picker", {
                    dateFormat: "d/m/Y",
                    defaultDate: "today",
                    locale: "pt",
                    static: true,
                    onChange: (selectedDates) => {
                        if (selectedDates[0]) this.changeDate(selectedDates[0]);
                    }
                });

                const backToTopBtn = document.getElementById('back-to-top-btn');
                if (backToTopBtn) {
                    document.getElementById('main-scroll').onscroll = (e) => {
                        if (e.target.scrollTop > 300) {
                            backToTopBtn.classList.remove('opacity-0', 'invisible');
                        } else {
                            backToTopBtn.classList.add('opacity-0', 'invisible');
                        }
                    };
                    backToTopBtn.onclick = () => {
                        document.getElementById('main-scroll').scrollTo({ top: 0, behavior: 'smooth' });
                    };
                }
            },

            debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; },

            renderNav() {
                const sMenu = document.getElementById('sport-menu');
                const mobSMenu = document.getElementById('mob-sport-menu');
                sMenu.innerHTML = ''; mobSMenu.innerHTML = '';

                Object.entries(this.state.sports).forEach(([k, v]) => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.innerText = v.name;
                    div.onclick = () => this.changeSport(k);
                    sMenu.appendChild(div);

                    const mobDiv = document.createElement('div');
                    mobDiv.className = 'p-2 text-gray-400 hover:text-white cursor-pointer';
                    mobDiv.innerText = v.name;
                    mobDiv.onclick = () => { this.changeSport(k); this.toggleMobileMenu(); };
                    mobSMenu.appendChild(mobDiv);
                });

                const lMenu = document.getElementById('league-menu');
                const sidebar = document.getElementById('sidebar-league-list');
                const mobSidebar = document.getElementById('mob-sidebar-league-list');
                lMenu.innerHTML = ''; sidebar.innerHTML = ''; mobSidebar.innerHTML = '';
                
                const leagues = this.state.sports[this.state.currentSport].leagues;
                Object.entries(leagues).forEach(([k, v]) => {
                    const dItem = document.createElement('div');
                    dItem.className = 'dropdown-item';
                    dItem.innerHTML = `<img src="${v.logo}"> ${v.name}`;
                    dItem.onclick = () => this.changeLeague(k);
                    lMenu.appendChild(dItem);

                    const sItem = document.createElement('button');
                    sItem.className = 'w-full text-left p-2 px-3 rounded-lg hover:bg-white/5 flex items-center gap-3 text-sm text-gray-400 hover:text-white transition';
                    sItem.innerHTML = `<img src="${v.logo}" class="w-5 h-5 object-contain"> ${v.name}`;
                    sItem.onclick = () => this.changeLeague(k);
                    sidebar.appendChild(sItem);

                    const mobSItem = sItem.cloneNode(true);
                    mobSItem.onclick = () => { this.changeLeague(k); this.toggleMobileMenu(); };
                    mobSidebar.appendChild(mobSItem);
                });

                const currL = leagues[this.state.currentLeague];
                document.getElementById('header-league-logo').src = currL.logo;
                document.getElementById('header-league-name').innerText = currL.name;
                document.getElementById('header-sport-name').innerText = this.state.sports[this.state.currentSport].name;
                lucide.createIcons();
            },

            changeSport(s) {
                this.state.currentSport = s;
                this.state.currentLeague = Object.keys(this.state.sports[s].leagues)[0];
                this.renderNav();
                this.loadLeague(this.state.currentLeague);
            },

            changeLeague(l) {
                this.state.currentLeague = l;
                document.querySelectorAll('.dropdown-menu').forEach(e => e.classList.remove('open'));
                this.renderNav();
                this.loadLeague(l);
            },

            changeDate(newDate) {
                this.state.currentDate = newDate;
                this.loadLeague(this.state.currentLeague);
            },

            formatDateForAPI(date) {
                return date.toISOString().split('T')[0].replace(/-/g, '');
            },

            toggleDropdown(id) {
                const el = document.getElementById(id);
                const wasOpen = el.classList.contains('open');
                document.querySelectorAll('.dropdown-menu').forEach(e => e.classList.remove('open'));
                if(!wasOpen) el.classList.add('open');
            },

            toggleMobileMenu() {
                const sidebar = document.getElementById('mobile-sidebar');
                const overlay = document.getElementById('mobile-sidebar-overlay');
                const isOpen = sidebar.classList.contains('translate-x-0');
                
                if(isOpen) {
                    sidebar.classList.remove('translate-x-0');
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                } else {
                    sidebar.classList.add('translate-x-0');
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                }
            },

            toggleMobileSearch() {
                const overlay = document.getElementById('mobile-search-overlay');
                overlay.classList.toggle('hidden');
                if (!overlay.classList.contains('hidden')) {
                    document.getElementById('mobile-search-input').focus();
                }
            },

            setView(v) {
                this.state.view = v;
                ['matches', 'standings', 'news', 'scorers', 'clubs', 'wiki', 'channels'].forEach(id => {
                    const el = document.getElementById('view-'+id);
                    if(el) el.classList.toggle('hidden', id !== v);
                });

                // Update active states
                ['matches', 'standings', 'news', 'clubs', 'channels'].forEach(type => {
                    const mobBtn = document.getElementById('mob-'+type);
                    const deskBtn = document.getElementById('desk-'+type);
                    
                    if(mobBtn) {
                        mobBtn.className = type === v 
                            ? "flex flex-col items-center gap-1 text-xs text-[#d1ff4d]" 
                            : "flex flex-col items-center gap-1 text-xs text-gray-500";
                    }
                    
                    if(deskBtn) {
                        deskBtn.className = type === v
                            ? "w-full text-left p-3 rounded-lg bg-white/10 flex items-center gap-3 font-semibold text-white group"
                            : "w-full text-left p-3 rounded-lg hover:bg-white/5 flex items-center gap-3 font-semibold text-gray-400 hover:text-white group";
                        const icon = deskBtn.querySelector('i');
                        if(icon) icon.classList.toggle('text-[#d1ff4d]', type === v);
                    }
                });

                if (v === 'channels') {
                    this.loadChannels();
                }
            },

            // --- CHANNELS LOGIC ---
            async loadChannels() {
                const grid = document.getElementById('channels-grid');
                grid.innerHTML = '<div class="col-span-full text-center py-10"><div class="spinner mx-auto"></div></div>';
                try {
                    const res = await fetch('/channels');
                    const json = await res.json();
                    this.renderChannels(json.data || []);
                } catch(e) {
                    grid.innerHTML = '<p class="text-center text-red-500 col-span-full">Erro ao carregar canais.</p>';
                }
            },

            renderChannels(channels) {
                const grid = document.getElementById('channels-grid');
                grid.innerHTML = '';
                channels.forEach(ch => {
                    const card = document.createElement('div');
                    card.className = "bg-dark-800 rounded-xl overflow-hidden hover:ring-2 hover:ring-brand-500 transition cursor-pointer group relative channel-card";
                    card.dataset.name = ch.name.toLowerCase();
                    card.dataset.id = ch.id;
                    card.onclick = () => this.playChannel(ch);
                    const logo = ch.logo_url || `https://ui-avatars.com/api/?name=${ch.name}&background=random`;
                    const isFav = this.state.favorites.includes(ch.id);
                    card.innerHTML = `
                        <div class="aspect-video bg-dark-700 flex items-center justify-center relative">
                            ${logo.includes('http') 
                                ? `<img src="${logo}" class="w-16 h-16 object-contain z-10">` 
                                : `<i data-lucide="tv" class="w-12 h-12 text-gray-500 group-hover:text-white transition z-10"></i>`
                            }
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition z-20">
                                <i data-lucide="play-circle" class="w-12 h-12 text-brand-500 fill-current"></i>
                            </div>
                            <button onclick="event.stopPropagation(); app.toggleFavorite('${ch.id}')" class="absolute top-2 right-2 z-30 p-1.5 rounded-full bg-black/60 hover:bg-brand-500 transition text-white ${isFav ? 'text-brand-500' : 'text-gray-400'}">
                                <i data-lucide="heart" class="w-4 h-4 ${isFav ? 'fill-current' : ''}"></i>
                            </button>
                        </div>
                        <div class="p-3">
                            <h3 class="font-bold text-white truncate">${ch.name}</h3>
                            <p class="text-xs text-gray-400 truncate">${ch.category}</p>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                lucide.createIcons();
                this.applyChannelFilters();
            },

            toggleFavorite(id) {
                if (this.state.favorites.includes(id)) {
                    this.state.favorites = this.state.favorites.filter(fid => fid !== id);
                } else {
                    this.state.favorites.push(id);
                }
                localStorage.setItem('tvlabs_favorites', JSON.stringify(this.state.favorites));
                this.loadChannels(); // Re-render to update icons
            },

            toggleFavoritesFilter() {
                this.state.showFavoritesOnly = !this.state.showFavoritesOnly;
                const btn = document.getElementById('btn-fav-filter');
                if (this.state.showFavoritesOnly) {
                    btn.classList.add('bg-brand-500', 'text-white', 'border-brand-500');
                    btn.classList.remove('bg-dark-800', 'text-gray-400');
                } else {
                    btn.classList.remove('bg-brand-500', 'text-white', 'border-brand-500');
                    btn.classList.add('bg-dark-800', 'text-gray-400');
                }
                this.applyChannelFilters();
            },

            filterChannels(query) {
                this.applyChannelFilters(query);
            },

            applyChannelFilters(query) {
                const term = (query !== undefined ? query : document.getElementById('channel-filter').value).toLowerCase();
                const cards = document.querySelectorAll('.channel-card');
                cards.forEach(card => {
                    const name = card.dataset.name;
                    const id = card.dataset.id;
                    const matchesSearch = name.includes(term);
                    const matchesFav = this.state.showFavoritesOnly ? this.state.favorites.includes(id) : true;
                    card.style.display = (matchesSearch && matchesFav) ? 'block' : 'none';
                });
            },

            playChannel(ch) {
                const container = document.getElementById('channel-player-container');
                const iframe = document.getElementById('iframe-src');
                container.classList.remove('hidden');
                iframe.src = ch.embed_url;
                container.scrollIntoView({ behavior: 'smooth' });
            },

            // --- SPORTS LOGIC ---
            async loadLeague(key) {
                this.state.isFirstStandingsRender = true;
                if (this.state.view !== 'matches') this.state.currentDate = new Date();
                this.setView('matches');
                const sport = this.state.currentSport;
                const league = this.state.sports[sport].leagues[key];

                if (this.state.matchRefreshInterval) clearInterval(this.state.matchRefreshInterval);
                this.state.matchRefreshInterval = null;
                
                document.getElementById('page-league-logo').src = league.logo;
                document.getElementById('page-league-name').innerText = league.name;
                if (league.bg) {
                    document.getElementById('bg-wrapper').style.backgroundImage = `url('${league.bg}')`;
                }

                document.getElementById('matches-grid').innerHTML = '<div class="text-center text-gray-500 py-10">Carregando jogos...</div>';

                try {
                    const formattedDate = this.formatDateForAPI(this.state.currentDate);
                    const isToday = this.state.currentDate.toDateString() === new Date().toDateString();
                    
                    document.getElementById('matches-date-title').textContent = isToday ? 'Jogos de Hoje' : `Jogos de ${this.state.currentDate.toLocaleDateString('pt-BR')}`;
                    
                    this.loadNews(sport, league.slug);
                    this.loadScoreboardWithFallback(sport, league, formattedDate, isToday);
                    this.loadStandings(sport, league);
                    this.loadScorers(sport, league.slug);

                } catch(e) {
                    console.error(e);
                }
            },

            async loadNews(sport, leagueSlug) {
                try {
                    const url = API_CONFIG.getNewsUrl(sport, leagueSlug, this.state.region);
                    const res = await fetch(url);
                    const data = await res.json();
                    this.renderNews(data.articles || []);
                } catch (e) { this.renderNews([]); }
            },

            async loadScoreboardWithFallback(sport, league, formattedDate, isToday) {
                const espnUrl = API_CONFIG.getScoreboardUrl(sport, league.slug, formattedDate);
                try {
                    const res = await fetch(espnUrl);
                    const data = await res.json();
                    this.renderMatches(data.events || []);

                    if (sport === 'soccer' && isToday) {
                        this.state.matchRefreshInterval = setInterval(() => this.updateScores(sport, league.slug), 20000);
                    }
                } catch (e) {
                    // Retry logic could go here
                }
            },

            getThemeClassForLeague(lKey) {
                if (!lKey) lKey = this.state.currentLeague;
                if (lKey.includes('brasileiraob')) return 'theme-brasileiraob';
                if (lKey.includes('libertadores')) return 'theme-libertadores';
                if (lKey.includes('champions')) return 'theme-champions';
                if (lKey.includes('premier')) return 'theme-premier';
                return 'theme-brasileirao';
            },

            renderMatches(events) {
                const grid = document.getElementById('matches-grid');
                grid.innerHTML = '';
                if(!events.length) { grid.innerHTML = '<p class="text-center text-gray-500">Sem jogos hoje.</p>'; return; }

                Object.values(this.state.timers).forEach(timer => clearInterval(timer.interval));
                this.state.timers = {};

                const hasLiveGames = events.some(ev => ev.status.type.state === 'in');
                document.getElementById('live-indicator').classList.toggle('hidden', !hasLiveGames);
                const themeClass = this.getThemeClassForLeague();

                events.forEach(ev => {
                    const comp = ev.competitions[0];
                    const home = comp.competitors.find(c => c.homeAway === 'home');
                    const away = comp.competitors.find(c => c.homeAway === 'away');
                    const status = ev.status;
                    const isLive = status.type.state === 'in';
                    const matchName = ev.name.replace(' em ', ' VS ');

                    const card = document.createElement('div');
                    card.className = `match-card ${themeClass}`;
                    card.onclick = () => this.openMatch(ev.id, themeClass, home.team.color);

                    card.innerHTML = `
                        <div class="tv-scoreboard">
                            <div class="tv-scoreboard-bg"></div>
                            <div class="tv-logo-box"><img src="${this.state.sports[this.state.currentSport].leagues[this.state.currentLeague].logo}"></div> 
                            <div class="tv-team-box text-right"><span class="truncate">${home.team.abbreviation || home.team.shortDisplayName}</span><img src="${home.team.logo}" class="w-6 h-6 object-contain ml-2"></div>
                            <div class="tv-score-box" data-match-id="${ev.id}">${home.score} - ${away.score}</div>
                            <div class="tv-team-box text-left"><img src="${away.team.logo}" class="w-6 h-6 object-contain mr-2"><span class="truncate">${away.team.abbreviation || away.team.shortDisplayName}</span></div>
                            <div class="tv-time-box" id="time-box-${ev.id}">
                                <div id="match-timer-${ev.id}" class="match-timer-main">${status.type.shortDetail}</div>
                                <div id="match-stoppage-time-${ev.id}" class="match-timer-stoppage"></div>
                            </div>
                        </div>
                        <div class="match-footer"><span>${matchName}</span><span>${comp.venue?.fullName || ''}</span></div>
                    `;
                    grid.appendChild(card);

                    if (isLive) {
                        this.startMatchTimer(ev.id, status.displayClock, status.type.shortDetail, comp);
                    }
                });
                lucide.createIcons();
            },

            async updateScores(sport, slug) {
                try {
                    const url = API_CONFIG.getScoreboardUrl(sport, slug, this.formatDateForAPI(this.state.currentDate));
                    const res = await fetch(url);
                    const data = await res.json();
                    if (!data.events) return;

                    data.events.forEach(event => {
                        const comp = event.competitions[0];
                        const home = comp.competitors.find(c => c.homeAway === 'home');
                        const away = comp.competitors.find(c => c.homeAway === 'away');
                        const scoreBox = document.querySelector(`.tv-score-box[data-match-id="${event.id}"]`);
                        if (!scoreBox) return;

                        const [oldH, oldA] = scoreBox.textContent.split('-').map(s => parseInt(s.trim()));
                        const newH = parseInt(home.score);
                        const newA = parseInt(away.score);

                        if (newH > oldH || newA > oldA) {
                            scoreBox.classList.add('goal-animation');
                            setTimeout(() => scoreBox.classList.remove('goal-animation'), 800);
                        }
                        scoreBox.textContent = `${home.score} - ${away.score}`;
                    });
                } catch (e) {}
            },

            async loadStandings(sport, league) {
                const container = document.getElementById('standings-container');
                container.innerHTML = '<p class="text-center text-gray-500 py-10 col-span-full">Carregando tabela...</p>';
                try {
                    const res = await fetch(API_CONFIG.getStandingsUrl(sport, league.slug));
                    const data = await res.json();
                    this.renderStandingsTable(data.children);
                    this.renderClubs(data.children);
                } catch (e) {
                    container.innerHTML = '<p class="text-center text-red-500 py-10 col-span-full">Tabela indisponível.</p>';
                }
            },

            renderStandingsTable(children) {
                const container = document.getElementById('standings-container');
                container.innerHTML = '';
                if (!children) return;
                
                const themeClass = this.getThemeClassForLeague();
                children.forEach(group => {
                    const div = document.createElement('div');
                    div.className = `bg-[#1a1b1e] rounded-xl border border-[#333] overflow-hidden h-fit ${themeClass}`;
                    
                    let html = `
                        <div class="p-3 flex justify-between items-center bg-white/5">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">${group.name}</span>
                        </div>
                        <div class="flex text-[10px] text-gray-500 px-2 py-2 border-b border-[#333] uppercase font-bold">
                            <span class="w-8 text-center">#</span>
                            <span class="flex-1 px-2">Time</span>
                            <span class="w-8 text-center">P</span>
                            <span class="w-8 text-center">J</span>
                            <span class="w-8 text-center">V</span>
                            <span class="w-8 text-center">E</span>
                            <span class="w-8 text-center">D</span>
                        </div>
                    `;
                    
                    let entries = group.standings.entries || [];
                    entries.sort((a, b) => a.stats.find(s => s.name === 'rank')?.value - b.stats.find(s => s.name === 'rank')?.value);
                    
                    entries.forEach((e) => {
                        const getStat = (n) => e.stats.find(s => s.name === n)?.value || 0;
                        const rank = getStat('rank');
                        let posColor = 'text-gray-500';
                        if (rank === 1) posColor = 'text-[#d1ff4d] font-bold';
                        else if (rank <= 4) posColor = 'text-blue-400 font-bold';
                        else if (rank >= entries.length - 3) posColor = 'text-red-400 font-bold';

                        html += `
                            <div class="flex items-center px-2 py-2 border-b border-[#333] hover:bg-white/5 text-sm">
                                <span class="w-8 text-center ${posColor}">${rank}</span>
                                <div class="flex-1 flex items-center gap-2 px-2 min-w-0">
                                    <img src="${e.team.logos?.[0]?.href}" class="w-5 h-5 object-contain">
                                    <span class="font-semibold text-white truncate">${e.team.shortDisplayName || e.team.displayName}</span>
                                </div>
                                <span class="w-8 text-center font-bold text-white">${getStat('points')}</span>
                                <span class="w-8 text-center text-gray-400">${getStat('gamesPlayed')}</span>
                                <span class="w-8 text-center text-gray-500">${getStat('wins')}</span>
                                <span class="w-8 text-center text-gray-500">${getStat('ties')}</span>
                                <span class="w-8 text-center text-gray-500">${getStat('losses')}</span>
                            </div>
                        `;
                    });
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            },

            async loadScorers(sport, leagueSlug) {
                const container = document.getElementById('scorers-grid');
                container.innerHTML = '<div class="text-center text-gray-500 py-10 col-span-full">Carregando artilheiros...</div>';
                try {
                    const scheduleUrl = API_CONFIG.getLeagueLeadersUrl(sport, leagueSlug);
                    const scheduleRes = await fetch(scheduleUrl);
                    const scheduleData = await scheduleRes.json();
                    
                    const gameIds = scheduleData.events
                        .filter(event => event.status.type.completed)
                        .map(event => event.id);

                    if (gameIds.length === 0) { container.innerHTML = ''; return; }

                    const summaryPromises = gameIds.map(id => 
                        fetch(API_CONFIG.getGameSummaryWithLeadersUrl(sport, leagueSlug, id))
                            .then(res => res.ok ? res.json() : null)
                    );
                    const summaries = await Promise.all(summaryPromises);
                    const playerGoals = {};
                    summaries.forEach(summary => {
                        if (!summary || !summary.leaders) return;
                        summary.leaders.forEach(leaderType => {
                            if (leaderType.shortDisplayName === 'Gols') {
                                leaderType.leaders.forEach(playerLeader => {
                                    const pid = playerLeader.athlete.id;
                                    if (!playerGoals[pid]) playerGoals[pid] = { player: playerLeader.athlete, team: playerLeader.team, goals: 0 };
                                    playerGoals[pid].goals += parseInt(playerLeader.value);
                                });
                            }
                        });
                    });

                    const sorted = Object.values(playerGoals).sort((a, b) => b.goals - a.goals).slice(0, 50);
                    container.innerHTML = '';
                    sorted.forEach((s, i) => {
                        container.innerHTML += `
                            <div class="bg-dark-800 p-3 rounded-lg flex items-center gap-4 border border-dark-700">
                                <span class="font-bold text-gray-500 w-6 text-center">${i + 1}</span>
                                <img src="${s.player.headshot?.href || 'https://a.espncdn.com/i/headshots/nophoto.png'}" class="w-10 h-10 rounded-full bg-dark-900 object-cover">
                                <div class="flex-1">
                                    <div class="font-bold text-white text-sm">${s.player.displayName}</div>
                                    <div class="text-xs text-gray-500">${s.team?.displayName || ''}</div>
                                </div>
                                <div class="font-black text-xl text-brand-500">${s.goals}</div>
                            </div>
                        `;
                    });
                } catch (e) { container.innerHTML = ''; }
            },

            renderNews(articles) {
                const grid = document.getElementById('news-grid');
                grid.innerHTML = '';
                articles.slice(0, 9).forEach(n => {
                    if (!n.images || !n.images[0]) return;
                    const card = document.createElement('a');
                    card.href = n.links.web.href;
                    card.target = '_blank';
                    card.className = 'group relative aspect-video rounded-xl overflow-hidden block';
                    card.innerHTML = `
                        <img src="${n.images[0].url}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent flex items-end p-4">
                            <h3 class="text-white font-bold leading-tight group-hover:text-[#d1ff4d] transition">${n.headline}</h3>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },

            renderClubs(children) {
                const grid = document.getElementById('clubs-grid');
                grid.innerHTML = '';
                const themeClass = this.getThemeClassForLeague();
                const seen = new Set();
                children.forEach(c => {
                    c.standings.entries.forEach(e => {
                        if(seen.has(e.team.id)) return;
                        seen.add(e.team.id);
                        grid.innerHTML += `
                            <div class="bg-dark-800 p-4 rounded-xl border border-dark-700 hover:border-brand-500 cursor-pointer transition flex flex-col items-center gap-2" onclick="app.openClub('${e.team.id}', '${e.team.displayName}', '${themeClass}')">
                                <img src="${e.team.logos?.[0]?.href}" class="h-12 object-contain">
                                <h4 class="text-xs font-bold text-white text-center truncate w-full">${e.team.displayName}</h4>
                            </div>
                        `;
                    });
                });
            },

            filterClubs(query) {
                const term = query.toLowerCase();
                document.querySelectorAll('#clubs-grid > div').forEach(el => {
                    const name = el.querySelector('h4').textContent.toLowerCase();
                    el.style.display = name.includes(term) ? 'flex' : 'none';
                });
            },

            startMatchTimer(matchId, initialClock, shortDetail, competition) {
                if (this.state.timers[matchId]) clearInterval(this.state.timers[matchId].interval);
                const timerEl = document.getElementById(`match-timer-${matchId}`);
                const stoppageEl = document.getElementById(`match-stoppage-time-${matchId}`);
                if (!timerEl || !stoppageEl) return;
                
                document.getElementById(`time-box-${matchId}`)?.classList.add('live-timer');
                if (!initialClock || !initialClock.includes(':')) { timerEl.textContent = shortDetail; return; }

                let [min, sec] = initialClock.replace("'", "").split(':').map(Number);
                const isExtra = competition.competitors.some(c => c.linescores?.some(l => l.period === 3));
                const maxTime = isExtra ? 120 : 90;
                const halfTime = maxTime / 2;

                const interval = setInterval(() => {
                    sec++;
                    if (sec >= 60) { sec = 0; min++; }
                    let dMin = min, dSec = sec, stop = 0;
                    
                    if (min >= halfTime && min < maxTime) { stop = min - halfTime; dMin = halfTime; dSec = 0; }
                    else if (min >= maxTime) { stop = min - maxTime; dMin = maxTime; dSec = 0; }

                    timerEl.textContent = `${String(dMin).padStart(2,'0')}:${String(dSec).padStart(2,'0')}`;
                    stoppageEl.textContent = stop > 0 ? `+${stop}` : '';
                }, 1000);

                this.state.timers[matchId] = { interval };
            },

            // --- MODALS ---
            async openMatch(id, themeClass, teamColor) {
                const modal = document.getElementById('match-modal');
                modal.classList.add('open');
                this.state.currentMatchId = id;
                this.setMatchTab('timeline');
                
                // Reset
                document.getElementById('modal-score-home').innerText = '0';
                document.getElementById('modal-score-away').innerText = '0';
                document.getElementById('timeline-container').innerHTML = '<div class="spinner mx-auto"></div>';

                const sport = this.state.currentSport;
                const league = this.state.sports[sport].leagues[this.state.currentLeague];

                try {
                    const res = await fetch(API_CONFIG.getGameSummaryUrl(sport, league.slug, id));
                    const data = await res.json();
                    const header = data.header.competitions[0];
                    const home = header.competitors.find(c=>c.homeAway==='home');
                    const away = header.competitors.find(c=>c.homeAway==='away');

                    document.getElementById('modal-home').innerText = home.team.abbreviation;
                    document.getElementById('modal-away').innerText = away.team.abbreviation;
                    document.getElementById('modal-home-logo').src = home.team.logos?.[0]?.href;
                    document.getElementById('modal-away-logo').src = away.team.logos?.[0]?.href;
                    document.getElementById('modal-score-home').innerText = home.score || 0;
                    document.getElementById('modal-score-away').innerText = away.score || 0;
                    document.getElementById('modal-status').innerText = header.status.type.description;

                    this.renderTimeline(data);
                    this.renderStats(data, teamColor);
                } catch(e) {}
            },
            renderTimeline(data) {
                const cont = document.getElementById('timeline-container');
                cont.innerHTML = '';
                let events = data.keyEvents ? [...data.keyEvents].reverse() : [];
                if(!events.length && data.header.competitions[0].details) {
                    events = data.header.competitions[0].details.map(d => ({
                        text: d.type?.text, shortText: d.shortText, clock: d.clock, participants: d.participants
                    }));
                }
                if(!events.length) { cont.innerHTML = '<p class="text-center text-gray-500">Sem lances.</p>'; return; }

                events.forEach(ev => {
                    const time = ev.clock?.displayValue || '-';
                    const text = ev.shortText || ev.text || '';
                    const part = ev.participants?.[0]?.athlete?.displayName || '';
                    let icon = 'circle';
                    if(text.toLowerCase().includes('gol')) icon = 'futbol';
                    else if(text.toLowerCase().includes('card')) icon = 'square';
                    
                    cont.innerHTML += `
                        <div class="timeline-item">
                            <div class="timeline-time">${time}</div>
                            <div class="w-8 h-8 flex items-center justify-center"><i data-lucide="${icon}" class="w-4 h-4 text-gray-400"></i></div>
                            <div><div class="text-white font-bold">${part}</div><div class="text-gray-500 text-xs">${text}</div></div>
                        </div>
                    `;
                });
                lucide.createIcons();
            },

            renderStats(data, color) {
                const cont = document.getElementById('stats-container');
                cont.innerHTML = '';
                if(!data.boxscore?.teams) return;
                const h = data.boxscore.teams[1].statistics;
                const a = data.boxscore.teams[0].statistics;
                
                h.forEach((s, i) => {
                    const vH = parseFloat(s.displayValue)||0;
                    const vA = parseFloat(a[i].displayValue)||0;
                    const total = vH+vA;
                    const pct = total > 0 ? (vH/total)*100 : 50;
                    cont.innerHTML += `
                        <div class="mb-4">
                            <div class="flex justify-between text-xs text-gray-400 font-bold mb-1 uppercase"><span>${s.displayValue}</span><span>${s.label}</span><span>${a[i].displayValue}</span></div>
                            <div class="flex h-2 bg-gray-800 rounded-full overflow-hidden">
                                <div style="width: ${pct}%; background-color: ${color}"></div>
                                <div class="bg-gray-600 flex-1"></div>
                            </div>
                        </div>
                    `;
                });
            },

            setMatchTab(t) {
                document.getElementById('match-tab-timeline').classList.toggle('hidden', t!=='timeline');
                document.getElementById('match-tab-stats').classList.toggle('hidden', t!=='stats');
                document.getElementById('tab-btn-timeline').classList.toggle('border-brand-500', t==='timeline');
                document.getElementById('tab-btn-stats').classList.toggle('border-brand-500', t==='stats');
            },

            closeModal(id) { document.getElementById(id).classList.remove('open'); },

            openClub(id, name, theme) {
                const modal = document.getElementById('club-modal');
                modal.classList.add('open');
                document.getElementById('club-modal-name').innerText = name;
                this.state.currentClubId = id;
                this.state.currentClubName = name;
                this.setClubTab('history');
            },

            async setClubTab(tab) {
                document.getElementById('club-view-history').classList.toggle('hidden', tab!=='history');
                document.getElementById('club-view-squad').classList.toggle('hidden', tab!=='squad');
                document.getElementById('club-tab-btn-history').classList.toggle('border-brand-500', tab==='history');
                document.getElementById('club-tab-btn-squad').classList.toggle('border-brand-500', tab==='squad');

                if(tab === 'history') {
                    const wikiTerm = this.state.teamWikiDb[this.state.currentLeague]?.[this.state.currentClubName] || this.state.currentClubName;
                    this.openWiki(wikiTerm, 'club-view-history');
                } else if(tab === 'squad') {
                    const cont = document.getElementById('club-view-squad');
                    cont.innerHTML = '<div class="spinner mx-auto"></div>';
                    try {
                        const s = this.state.currentSport;
                        const l = this.state.sports[s].leagues[this.state.currentLeague];
                        const r = await fetch(API_CONFIG.getTeamRosterUrl(s, l.slug, this.state.currentClubId));
                        const d = await r.json();
                        cont.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>';
                        const grid = cont.firstElementChild;
                        (d.athletes||[]).forEach(a => {
                            grid.innerHTML += `<div class="bg-[#1a1b1e] border border-[#333] p-3 rounded flex items-center gap-4"><img src="${a.headshot?.href || 'https://via.placeholder.com/50'}" class="w-12 h-12 rounded-full bg-black object-cover"><div><div class="font-bold text-white">${a.fullName}</div><div class="text-xs text-gray-500">${a.position?.displayName||''}</div></div></div>`;
                        });
                    } catch(e) { cont.innerHTML='<p>Elenco indisponível.</p>'; }
                }
            },

            async openWiki(term, containerId = 'wiki-content') {
                if (containerId === 'wiki-content') this.setView('wiki');
                const cont = document.getElementById(containerId);
                cont.innerHTML = '<div class="spinner mx-auto"></div>';
                try {
                    const res = await fetch(API_CONFIG.getWikiParseUrl(term));
                    const data = await res.json();
                    cont.innerHTML = `<h2 class="text-2xl font-bold text-white mb-4 ${containerId !== 'wiki-content' ? 'hidden' : ''}">${data.parse.title}</h2><div class="prose prose-invert max-w-none">${data.parse.text}</div>`;
                } catch(e) { cont.innerHTML = `<p class="text-red-500">Erro ao carregar Wiki.</p>`; }
            },

            async handleSearch(q, isMobile) {
                const resDiv = document.getElementById(isMobile ? 'mobile-search-results' : 'global-search-results');
                if(q.length < 3) { resDiv.classList.add('hidden'); return; }
                resDiv.classList.remove('hidden');
                resDiv.innerHTML = '<div class="p-4 text-center text-gray-500">Buscando...</div>';
                
                try {
                    const res = await fetch(API_CONFIG.getWikiSearchUrl(q));
                    const data = await res.json();
                    let html = '';
                    if(data[1].length) {
                        data[1].forEach(t => {
                            html += `<div class="p-3 hover:bg-white/5 text-sm text-white cursor-pointer" onclick="app.openWiki('${t}')">${t}</div>`;
                        });
                    }
                    resDiv.innerHTML = html || '<div class="p-4 text-center text-gray-500">Nada encontrado.</div>';
                } catch(e) {}
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>